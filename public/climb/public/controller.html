<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Climb Game â€“ Controller</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    :root {
      --bg: #0b1020;
      --fg: #e8f0ff;
      --card: #111a33;
      --muted: #8aa0c7;
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, Apple SD Gothic Neo, sans-serif;
      display: grid;
      place-items: center
    }

    .wrap {
      width: min(560px, 92vw);
      display: grid;
      gap: 12px
    }

    .card {
      background: var(--card);
      border: 1px solid #22325a;
      border-radius: 16px;
      padding: 14px
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    input,
    button {
      font-size: 16px;
      border-radius: 12px;
      border: 1px solid #2a3a66;
      background: #0a1430;
      color: var(--fg);
      padding: 12px
    }

    button.primary {
      background: #51cf66;
      border-color: #51cf66;
      color: #0b1020;
      font-weight: 700
    }

    button.warn {
      background: #2a71ff;
      border-color: #2a71ff;
      font-weight: 700
    }

    button.ghost {
      background: #111a33;
    }

    .muted {
      color: var(--muted);
      font-size: 13px
    }

    .big {
      font-size: 22px;
      font-weight: 700
    }

    .status {
      min-height: 20px
    }

    .meter {
      height: 14px;
      border-radius: 8px;
      background: #111a33;
      overflow: hidden
    }

    .bar {
      height: 100%;
      width: 0%;
      background: #4dabf7;
      transition: width 80ms linear;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      height: 100dvh;
      /* Dynamic viewport height for mobile */
      background: rgba(11, 16, 32, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.2s ease, visibility 0.2s ease;
      -webkit-overflow-scrolling: touch;
      touch-action: manipulation;
    }

    .modal-overlay.show {
      visibility: visible;
      opacity: 1;
    }

    .modal {
      background: var(--card);
      border: 2px solid #22325a;
      border-radius: 20px;
      padding: 32px;
      min-width: 280px;
      max-width: 90vw;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .modal-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .modal-title.win {
      color: #51cf66;
    }

    .modal-title.lose {
      color: #ff6b6b;
    }

    .modal button {
      margin-top: 20px;
      width: 100%;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div class="big">Climb Controller</div>
      </div>
      <div class="row">
        <label>Room</label>
        <input id="room" style="flex:1" />
        <input id="name" placeholder="ë‹‰ë„¤ì„" style="flex:1" />
      </div>
      <div class="row">
        <button id="perm" class="warn">ëª¨ì…˜ ê¶Œí•œ</button>
        <button id="join" class="ghost">Join</button>
        <button id="start" class="primary" style="flex:1" disabled>Start Game</button>
        <button id="stop" class="ghost" style="flex:1" disabled>Stop</button>
      </div>
      <div class="row">
        <button id="joinQueue" style="flex:1">í ì°¸ê°€</button>
        <button id="leaveQueue" style="flex:1">í ë‚˜ê°€ê¸°</button>
        <button id="resetQueue">í ì´ˆê¸°í™”</button>
      </div>
      <div class="meter">
        <div id="bar" class="bar"></div>
      </div>
      <div class="muted">íœ´ëŒ€í°ì„ <b>ì„¸ì›Œì„œ</b> ìœ„ì•„ë˜ë¡œ í”ë“¤ë©´ ì˜¬ë¼ê°‘ë‹ˆë‹¤. (ìµœëŒ€ 4ëª…)</div>
      <div class="status" id="status">ëŒ€ê¸°ì¤‘â€¦</div>
      <div class="muted" id="playerCount">ì°¸ì—¬ì: 0ëª…</div>
      <div class="muted" id="queueStatus">í: []</div>
    </div>
  </div>

  <!-- Game Over Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-title" id="modalTitle"></div>
      <button class="primary" id="modalClose">í™•ì¸</button>
    </div>
  </div>

  <script>
    // ====== Config (ë„¤ì„ìŠ¤í˜ì´ìŠ¤/í”„ë¡ì‹œ ê²½ë¡œ í•„ìš” ì‹œ ìˆ˜ì •) ======
    const SOCKET_NAMESPACE = 'https://static-dev.zipshowkorea.com/climb'; // ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¯¸ì‚¬ìš©ì´ë©´ '/' ë¡œ ë³€ê²½
    const SOCKET_PATH = '/socket'; // Nginxì—ì„œ /socket ì—…ê·¸ë ˆì´ë“œ í”„ë¡ì‹œ ì‚¬ìš© ì‹œ ìœ ì§€

    // ====== ì´ˆê¸°í™” ======
    const url = new URL(location.href);
    const roomInput = document.getElementById("room");
    const nameInput = document.getElementById("name");
    const bar = document.getElementById("bar");
    const statusEl = document.getElementById("status");
    const playerCountEl = document.getElementById("playerCount");
    const btnPerm = document.getElementById("perm");
    const btnJoin = document.getElementById("join");
    const btnStart = document.getElementById("start");
    const btnStop = document.getElementById("stop");
    const modalOverlay = document.getElementById("modalOverlay");
    const modalTitle = document.getElementById("modalTitle");
    const modalClose = document.getElementById("modalClose");

    function setStatus(t) {
      statusEl.textContent = t;
    }

    function showModal(title, type) {
      console.log('showModal called:', title, type);
      modalTitle.textContent = title;
      modalTitle.className = 'modal-title ' + type;
      document.body.style.overflow = 'hidden';
      modalOverlay.classList.add('show');
      console.log('Modal overlay classes:', modalOverlay.className);
    }

    function hideModal() {
      modalOverlay.classList.remove('show');
      document.body.style.overflow = '';
    }

    modalClose.onclick = hideModal;
    const room = () => (roomInput.value || 'DEMO').toUpperCase();
    const playerName = () => (nameInput.value || 'Player').slice(0, 16);

    // URL íŒŒë¼ë¯¸í„°ë¡œ roomì´ ì˜¤ë©´ ì„¸íŒ…+ì ê¸ˆ(ì„ íƒ)
    const roomFromQR = (url.searchParams.get("room") || "DEMO").toUpperCase();
    roomInput.value = roomFromQR;
    if (roomFromQR) roomInput.readOnly = true;

    // ëœë¤ ë‹‰ë„¤ì„ ê¸°ë³¸ê°’
    nameInput.value = "Player" + Math.floor(Math.random() * 1000);

    // ====== Socket ======
    const socket = io(SOCKET_NAMESPACE, {
      path: SOCKET_PATH,
      query: {
        role: 'controller',
        room: room()
      },
      reconnection: true,
      transports: ['websocket'],
    });

    socket.on('connect', () => {
      setStatus(`ì†Œì¼“ ì—°ê²°ë¨ (#${socket.id})`);
      // ë°© ì •ë³´ ë°”ë€Œì—ˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì¬ì¡°ì¸ ë²„íŠ¼ìœ¼ë¡œ ëª…ì‹œì  ì²˜ë¦¬
      btnJoin.disabled = false;
      // í ìƒíƒœ ìš”ì²­
      socket.emit("status-queue");
    });

    // í ìƒíƒœ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
    socket.on("status-queue", (queue) => {
      document.getElementById("queueStatus").textContent = `í: [${queue.join(", ")}]`;
    });

    socket.on('joinedRoom', ({
      room,
      playerCount
    }) => {
      setStatus(`Joined room ${room}. ê²Œì„ ì‹œì‘ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...`);
      if (playerCount !== undefined) {
        playerCountEl.textContent = `ì°¸ì—¬ì: ${playerCount}ëª…`;
      }
      btnStart.disabled = false;
    });

    socket.on('gameStarted', () => {
      // ì„œë²„ì—ì„œ ë¼ìš´ë“œ ì‹œì‘ ë¸Œë¡œë“œìºìŠ¤íŠ¸ê°€ ì˜¤ë©´ ê²Œì´ì§€ ì´ˆê¸°í™”(ì„ íƒ)
      bar.style.width = '0%';
      setStatus('ê²Œì„ ì‹œì‘! ëª¨ì…˜ ìŠ¤íŠ¸ë¦¬ë° ì¤‘...');
      startMotion();
      btnStart.disabled = true;
      btnStop.disabled = false;
    });

    socket.on('gameOver', ({
      winnerId
    }) => {
      console.log('gameOver event received, winnerId:', winnerId, 'socket.id:', socket.id);
      stopMotion();
      if (winnerId && winnerId !== socket.id) {
        showModal('Lose ğŸ˜¢', 'lose');
      } else if (winnerId === socket.id) {
        showModal('Win! ğŸ‰', 'win');
      }
      // winnerIdê°€ nullì´ë©´ (display disconnected ë“±) ìƒíƒœ ìœ ì§€
    })

    socket.on('roomPlayerCount', ({
      room,
      playerCount
    }) => {
      playerCountEl.textContent = `ì°¸ì—¬ì: ${playerCount}ëª…`;
    });

    socket.on('error', (e) => {
      setStatus(`Error: ${e.message || e}`);
    });

    // ====== Join / ê¶Œí•œ / ëª¨ì…˜ ======
    btnJoin.onclick = () => {
      socket.emit('joinRoom', {
        room: room(),
        name: playerName()
      });
      setStatus('Join ìš”ì²­ ì „ì†¡â€¦');
    };

    btnPerm.onclick = async () => {
      try {
        // iOS ê¶Œí•œ ìš”ì²­
        if (typeof DeviceMotionEvent !== 'undefined' &&
          typeof DeviceMotionEvent.requestPermission === 'function') {
          const r1 = await DeviceMotionEvent.requestPermission();
          if (r1 !== 'granted') return alert('ëª¨ì…˜ ê¶Œí•œ ê±°ë¶€ë¨');
        }
        if (typeof DeviceOrientationEvent !== 'undefined' &&
          typeof DeviceOrientationEvent.requestPermission === 'function') {
          await DeviceOrientationEvent.requestPermission().catch(() => {});
        }
        alert('ëª¨ì…˜ ê¶Œí•œ OK');
      } catch (e) {
        alert('ê¶Œí•œ ìš”ì²­ ì˜¤ë¥˜: ' + e.message);
      }
    };

    // ëª¨ì…˜ íŒŒì´í”„ë¼ì¸ íŒŒë¼ë¯¸í„°
    const SEND_INTERVAL = 50; // 50ms (20Hz)
    const THRESH = 0.8; // ë…¸ì´ì¦ˆ ì»·
    const MAX_DELTA = 20; // ì„œë²„ì™€ í•©ì˜ëœ ìƒí•œ(ì•ˆí‹°ì¹˜íŠ¸)
    let enabled = false;
    let bucket = 0;
    let prevMag = 0;
    let sendTimer = null;

    btnStart.onclick = () => {
      // ê²Œì„ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ë‹¤ë©´ startGame ë³´ë‚´ê¸°
      socket.emit('startGame');
      setStatus('ê²Œì„ ì‹œì‘ ìš”ì²­ ì „ì†¡...');
    };
    btnStop.onclick = () => {
      stopMotion();
      socket.disconnect();
      btnStart.disabled = false;
      btnStop.disabled = true;
      bar.style.width = '0%';
    };

    function startMotion() {
      if (enabled) return;
      enabled = true;
      setStatus('Motion streamingâ€¦');

      window.addEventListener('devicemotion', onMotion, {
        passive: true
      });

      sendTimer = setInterval(() => {
        if (!enabled) return;
        // ëˆ„ì ì¹˜ë¥¼ ì„œë²„ë¡œ ì „ì†¡
        if (bucket <= 0) return;
        const delta = Math.min(bucket, MAX_DELTA);
        socket.emit('shake', {
          delta
        });
        bucket = 0;
      }, SEND_INTERVAL);
    }

    function stopMotion() {
      if (!enabled) return;
      enabled = false;
      setStatus('ëŒ€ê¸°ì¤‘');
      window.removeEventListener('devicemotion', onMotion);
      if (sendTimer) {
        clearInterval(sendTimer);
        sendTimer = null;
      }
    }

    function onMotion(e) {
      const ag = e.accelerationIncludingGravity || {
        x: 0,
        y: 0,
        z: 0
      };
      const a = e.acceleration || ag;

      // ì „ì²´ ê°€ì†ë„ì˜ í¬ê¸° ì‚¬ìš© (ë°©í–¥ì„± ë¬´ì‹œ, ìœ„ì•„ë˜ í”ë“¤ê¸° ìœ ë¦¬)
      const mag = Math.hypot(a.x || 0, a.y || 0, a.z || 0);

      // ë³€í™”ëŸ‰( jerk ìœ ì‚¬ ) ê¸°ë°˜ ì¦ë¶„
      let delta = Math.max(0, mag - prevMag);
      prevMag = mag;

      // ë…¸ì´ì¦ˆ ì»·
      if (delta < THRESH) delta = 0;

      bucket += delta;

      // ì‚¬ìš©ì í”¼ë“œë°± ê²Œì´ì§€ (ì„ì˜ ìŠ¤ì¼€ì¼)
      const uiVal = Math.max(0, Math.min(100, (delta * 8)));
      bar.style.width = uiVal + '%';
    }

    // í ê´€ë ¨ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById("joinQueue").onclick = () => {
      socket.emit("join-queue");
      setStatus("í ì°¸ê°€ ìš”ì²­");
    };

    document.getElementById("leaveQueue").onclick = () => {
      socket.emit("leave-queue");
      setStatus("í ë‚˜ê°€ê¸° ìš”ì²­");
    };

    document.getElementById("resetQueue").onclick = () => {
      socket.emit("reset-queue", {
        project: room()
      });
      setStatus("í ì´ˆê¸°í™” ìš”ì²­");
    };

    // í˜ì´ì§€ ì´íƒˆ ì‹œ ì •ë¦¬
    window.addEventListener('pagehide', stopMotion);
    window.addEventListener('beforeunload', stopMotion);
  </script>
</body>

</html>